<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dirk Steele Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- PapaParse for CSV -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <!-- js-yaml for YAML -->
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .status-green { background-color: #10b981; }
        .status-amber { background-color: #f59e0b; }
        .status-red { background-color: #ef4444; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex min-h-screen">
        <!-- Sidebar for Responsibilities -->
        <aside class="w-80 bg-white shadow-lg p-6 overflow-y-auto">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">General Responsibilities</h2>
            <div id="responsibilities-container" class="space-y-4">
                <!-- Responsibilities will be loaded here -->
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="flex-1 p-8">
            <!-- Header -->
            <header class="mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-2">Dirk Steele Dashboard</h1>
                <p class="text-gray-600">Executive Overview - Real-time Performance Metrics</p>
            </header>
            
            <!-- Current Status Cards -->
            <section class="mb-12">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Current Status</h2>
                <div id="status-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
                    <!-- Cards will be loaded here -->
                </div>
            </section>
            
            <!-- Progress Over Time Charts -->
            <section class="bg-white rounded-lg shadow-lg p-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Progress Over Time</h2>
                <div id="charts-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Individual charts will be loaded here -->
                </div>
            </section>
        </main>
    </div>

    <script>
        // RAG Status Function (Red-Amber-Green)
        function getStatusColor(value, metric) {
            const percentage = calculatePercentage(value, metric);
            if (percentage >= 90) return 'status-green';
            if (percentage >= 75) return 'status-amber';
            return 'status-red';
        }
        
        function getStatusText(value, metric) {
            const percentage = calculatePercentage(value, metric);
            if (percentage >= 90) return 'Excellent';
            if (percentage >= 75) return 'Good';
            return 'Needs Attention';
        }
        
        // Calculate percentage based on metric range and direction
        function calculatePercentage(value, metric) {
            const range = metricRanges[metric];
            if (!range) return 0;
            
            // Handle edge case where max equals min
            if (range.max === range.min) {
                return value === range.max ? 100 : 0;
            }
            
            const normalizedValue = (value - range.min) / (range.max - range.min) * 100;
            
            // Invert for metrics where lower is better
            let percentage = range.lowerIsBetter ? (100 - normalizedValue) : normalizedValue;
            
            // Clamp to 0-100 range to handle out-of-bounds values
            return Math.max(0, Math.min(100, percentage));
        }
        
        // Format metric name
        function formatMetricName(key) {
            return key.split('_').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }
        
        // Sanitize metric name for valid HTML ID
        function sanitizeMetricId(metric) {
            // Convert metric name to valid HTML ID (alphanumeric, hyphens, underscores only)
            return metric.replace(/[^a-zA-Z0-9_-]/g, '-').toLowerCase();
        }
        
        // Load and display responsibilities from YAML
        async function loadResponsibilities() {
            try {
                const response = await fetch('config.yaml');
                if (!response.ok) {
                    throw new Error(`Failed to fetch config.yaml: ${response.status}`);
                }
                const yamlText = await response.text();
                const data = jsyaml.load(yamlText);
                
                // Validate data structure
                if (!data || !data.general_responsibilities || !Array.isArray(data.general_responsibilities)) {
                    throw new Error('Invalid YAML structure: missing general_responsibilities array');
                }
                
                const container = document.getElementById('responsibilities-container');
                container.innerHTML = '';
                
                data.general_responsibilities.forEach(resp => {
                    const card = document.createElement('div');
                    card.className = 'border-l-4 border-blue-500 bg-gray-50 p-4 rounded-r-lg';
                    
                    const title = document.createElement('h3');
                    title.className = 'font-semibold text-gray-900 mb-2';
                    title.textContent = resp.title || 'N/A';
                    
                    const description = document.createElement('p');
                    description.className = 'text-sm text-gray-700 mb-2';
                    description.textContent = resp.description || 'N/A';
                    
                    const owner = document.createElement('p');
                    owner.className = 'text-xs text-gray-500 font-medium';
                    owner.textContent = 'Owner: ' + (resp.owner || 'N/A');
                    
                    card.appendChild(title);
                    card.appendChild(description);
                    card.appendChild(owner);
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading responsibilities:', error);
                const container = document.getElementById('responsibilities-container');
                const errorMsg = document.createElement('p');
                errorMsg.className = 'text-red-600 text-sm';
                errorMsg.textContent = 'Failed to load responsibilities. Please check console for details.';
                container.appendChild(errorMsg);
            }
        }
        
        // Load and display status data from CSV
        async function loadStatusData() {
            try {
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vS3C1WvZNWdMImmuKF_Jqi8Y8zggyboVvidEU2fzHjhNlLikBb5nDrf3CNFWGwd1HKzjbDyytM8LT8U/pub?gid=0&single=true&output=csv');
                if (!response.ok) {
                    throw new Error(`Failed to fetch status data: ${response.status}`);
                }
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    complete: function(results) {
                        const data = results.data.filter(row => row.date); // Filter out empty rows
                        
                        if (data.length === 0) {
                            throw new Error('No valid data rows found in CSV');
                        }
                        
                        // Display current status (latest row)
                        displayCurrentStatus(data[data.length - 1]);
                        
                        // Display progress chart (all rows)
                        displayProgressChart(data);
                    },
                    error: function(error) {
                        throw new Error('CSV parsing error: ' + error.message);
                    }
                });
            } catch (error) {
                console.error('Error loading status data:', error);
                const statusContainer = document.getElementById('status-cards');
                const errorMsg = document.createElement('p');
                errorMsg.className = 'text-red-600 col-span-full';
                errorMsg.textContent = 'Failed to load status data. Please check console for details.';
                statusContainer.appendChild(errorMsg);
            }
        }
        
        // Display current status cards
        function displayCurrentStatus(latestData) {
            const container = document.getElementById('status-cards');
            container.innerHTML = '';
            
            // Get all metrics except date
            const metrics = Object.keys(latestData).filter(key => key !== 'date');
            
            metrics.forEach(metric => {
                const value = latestData[metric];
                const statusColor = getStatusColor(value, metric);
                const statusText = getStatusText(value, metric);
                const range = metricRanges[metric] || { min: 0, max: 100, unit: '', lowerIsBetter: false };
                
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-6 border-t-4 border-blue-500 hover:shadow-lg transition-shadow';
                
                // Create header div with metric name and status indicator
                const header = document.createElement('div');
                header.className = 'flex items-center justify-between mb-3';
                
                const title = document.createElement('h3');
                title.className = 'text-sm font-medium text-gray-600 uppercase';
                title.textContent = formatMetricName(metric);
                
                const statusIndicator = document.createElement('div');
                statusIndicator.className = `${statusColor} w-3 h-3 rounded-full`;
                
                header.appendChild(title);
                header.appendChild(statusIndicator);
                
                // Create value display
                const valueDiv = document.createElement('div');
                valueDiv.className = 'mb-2';
                
                const valueSpan = document.createElement('span');
                valueSpan.className = 'text-4xl font-bold text-gray-900';
                valueSpan.textContent = value;
                
                const unitSpan = document.createElement('span');
                unitSpan.className = 'text-2xl text-gray-500';
                unitSpan.textContent = range.unit;
                
                valueDiv.appendChild(valueSpan);
                valueDiv.appendChild(unitSpan);
                
                // Create status text
                const statusPara = document.createElement('p');
                statusPara.className = 'text-sm text-gray-600';
                statusPara.textContent = statusText;
                
                // Assemble card
                card.appendChild(header);
                card.appendChild(valueDiv);
                card.appendChild(statusPara);
                container.appendChild(card);
            });
        }
        
        // Define custom ranges for each metric
        const metricRanges = {
            'glass_repair_completion': { min: 0, max: 20, unit: '', lowerIsBetter: true },
            'pm_records_filed': { min: 0, max: 100, unit: '', lowerIsBetter: false },
            'missing_keys': { min: 0, max: 20, unit: '', lowerIsBetter: true },
            'atl_ro_levels': { min: 200, max: 1000, unit: '', lowerIsBetter: true },
            'oil_5_30': { min: 5, max: 50, unit: '"', lowerIsBetter: false },
            'oil_0_20': { min: 5, max: 50, unit: '"', lowerIsBetter: false },
            'oil_waste': { min: 5, max: 50, unit: '"', lowerIsBetter: false }
        };
        
        // Store chart instances for cleanup
        let chartInstances = [];
        
        // Display progress charts - one per metric
        function displayProgressChart(data) {
            // Validate we have data
            if (!data || data.length === 0) {
                console.error('No data available for chart');
                return;
            }
            
            // Destroy existing chart instances to prevent memory leaks
            chartInstances.forEach(chart => chart.destroy());
            chartInstances = [];
            
            const container = document.getElementById('charts-container');
            container.innerHTML = '';
            
            // Extract dates and metrics
            const dates = data.map(row => row.date);
            const metrics = Object.keys(data[0]).filter(key => key !== 'date');
            
            const colors = [
                { border: '#3b82f6', background: '#3b82f633' }, // blue
                { border: '#10b981', background: '#10b98133' }, // green
                { border: '#f59e0b', background: '#f59e0b33' }, // amber
                { border: '#ef4444', background: '#ef444433' }, // red
                { border: '#8b5cf6', background: '#8b5cf633' }, // purple
            ];
            
            // Create a separate chart for each metric (limit to 10 for performance)
            metrics.slice(0, 10).forEach((metric, index) => {
                // Create chart container
                const chartDiv = document.createElement('div');
                chartDiv.className = 'bg-gray-50 rounded-lg p-6 border border-gray-200';
                
                const title = document.createElement('h3');
                title.className = 'text-lg font-semibold text-gray-700 mb-4';
                title.textContent = formatMetricName(metric);
                
                const canvasWrapper = document.createElement('div');
                canvasWrapper.className = 'h-64';
                
                const canvas = document.createElement('canvas');
                canvas.id = `chart-${sanitizeMetricId(metric)}`;
                canvas.setAttribute('role', 'img');
                canvas.setAttribute('aria-label', `Line chart showing ${formatMetricName(metric)} over time`);
                
                canvasWrapper.appendChild(canvas);
                chartDiv.appendChild(title);
                chartDiv.appendChild(canvasWrapper);
                container.appendChild(chartDiv);
                
                // Get range for this metric, or use default
                const range = metricRanges[metric] || { min: 0, max: 100, unit: '%' };
                const colorScheme = colors[index % colors.length];
                
                // Create the chart
                const ctx = canvas.getContext('2d');
                const chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: formatMetricName(metric),
                            data: data.map(row => row[metric]),
                            borderColor: colorScheme.border,
                            backgroundColor: colorScheme.background,
                            tension: 0.3,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    size: 13
                                },
                                callbacks: {
                                    label: function(context) {
                                        return context.parsed.y + range.unit;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: range.min,
                                max: range.max,
                                ticks: {
                                    callback: function(value) {
                                        return value + range.unit;
                                    },
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                });
                
                // Store chart instance for cleanup
                chartInstances.push(chartInstance);
            });
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadResponsibilities();
            loadStatusData();
        });
    </script>
</body>
</html>
